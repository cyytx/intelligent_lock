# 智能门锁项目

**基于 STM32F7 的物联网安防系统（开发中）**  

---

## 1. 设计初衷

本项目旨在设计一款面向智能家居安防的低功耗智能门锁系统，**计划实现以下核心功能**：  

- **多模式身份验证**：支持指纹、人脸、NFC、BLE、WiFi远程及按键密码开锁，提升安全性和便捷性。  
- **安防监控**：通过摄像头实时录制访客视频，支持本地存储与云端上传（需网络模块配合）。  
- **低功耗管理**：利用红外感应自动唤醒系统，非工作时段关闭高耗能模块（如LCD、WiFi）。  
- **交互体验**：通过图形界面（LVGL）显示状态与操作提示，舵机控制机械锁芯实现物理开锁。  

---

## 2. 硬件模块

系统采用模块化设计，核心组件如下：  

| **模块分类**  | **型号/接口**                  | **功能描述**            |
| --------- | -------------------------- | ------------------- |
| **主控单元**  | STM32F7IGT6（DCMI/SDIO/SPI） | 多任务调度与外设控制          |
| **存储与扩展** | SD卡（SDIO）                  | 视频/日志存储（暂未开发）       |
| **传感器**   | OV2640摄像头（DCMI）            | JPEG/RGB格式视频采集与实时输出 |
|           | 红外检测（GPIO中断）               | 靠近唤醒系统              |
|           | 人脸识别（UART+USB）             | 人脸录入及验证（暂未开发）       |
| **通信模块**  | WiFi W8801（SDIO）           | 云端数据传输（暂未移植完成）      |
|           | BLE（UART6）                 | 手机远程开锁指令透传          |
|           | NFC RC522（SPI5）            | 近场通信开锁              |
|           | 指纹识别模块（UART4）              | 指纹录入、比对与验证          |
| **人机交互**  | 320×240 TFT LCD（SPI2）      | 状态显示与密码输入           |
|           | 按键矩阵（中断GPIO扫描）             | 密码输入与功能操作           |
| **执行与反馈** | SG90舵机（PWM）                | 机械锁芯控制              |
|           | 蜂鸣器/LED（GPIO）              | 状态提示（音效与灯光反馈）       |

### 硬件模块结构图

![](assets/images/Pasted%20image%2020250304021235.png)
---

### 硬件实物图

![](assets/images/Pasted%20image%2020250312172925.png)

## 3.软件架构

#### 1. 摄像头与LCD显示架构

- **数据采集**：OV2640摄像头通过 **DCMI+DMA** 直接捕获RGB格式视频流，无需CPU干预，降低负载。  
- **任务协作**：  
  - **摄像头任务**：DMA将视频帧存入缓冲区后，通过 **消息队列** (`xQueueSend`) 将数据传递给LCD任务。  
  - **LCD任务**：从队列中读取视频帧，通过 **SPI+DMA** 驱动320×240 TFT LCD显示实时画面。  
- **优化设计**：  
  - **零拷贝机制**：DMA直接传输数据到LCD显存，避免内存重复拷贝。  
  - **动态刷新**：待机时关闭LCD背光，红外触发唤醒后自动恢复显示。

---

#### 2. 四种开锁验证架构

所有开锁方式均通过 **FreeRTOS事件驱动机制** 实现，核心流程如下：  

1. **触发验证**  
   
   - **按键开锁**：GPIO中断触发，通知按键扫描任务开始按键扫描，验证密码后给SG90任务发送开锁命令
   - **BLE开锁**：红外唤醒系统后，BLE任务启动广播；手机连接后通过UART6接收密码，验证成功后触发事件。  
   - **NFC开锁**：保持NFC 任务低频检测卡片，R校验密钥及读取数据对比后一致，则发送解锁命令给SG90任务  
   - **指纹开锁**：指纹按下GPIO中断，通知指纹任务并给指纹模块发送自动验证指纹指,随后接收指纹模块比对结果，匹配成功后触发解锁。  

2. **统一响应**  
   
   - **事件队列**：所有验证成功后，均通过 **`xQueueSend`** 向`SG90_Task`发送`unlock_event`。  
   - **舵机控制**：`SG90_Task`接收到事件后，驱动PWM信号开锁，并通过LED/蜂鸣器反馈状态。  

#### 3. 架构设计说明

- **FreeRTOS多任务调度**：  
  - 高优先级任务（摄像头采集、舵机控制）保障实时性，低优先级任务（日志、存储）后台运行。  
  - **事件组与队列**：解耦任务间依赖，确保线程安全与资源隔离。  
- **硬件加速**：  
  - **DMA** 用于摄像头、LCD数据传输，释放CPU资源。  
  - **PWM** 直接控制舵机，无需软件模拟。  

---

## 4. 开发现状

**已完成功能**：  

- ✅ **摄像头实时预览**：通过DCMI+DMA捕获RGB数据，解码为JPEG并显示在LCD（分辨率320×240）。  
- ✅ **多模式开锁**：  
  - 按键密码输入（含防抖与超时逻辑）。  
  - BLE透传指令（支持手机端远程控制）。  
  - NFC卡号匹配（RC522读卡器验证）。  
  - 指纹识别（协议解析与比对）。  
- ✅ **视频传输**：通过UART1将摄像头JPEG数据实时发送到PC端显示（调试模式）。   

**开发中功能**：  

- 🚧 **WiFi通信**：SDIO驱动适配与云端协议开发（预计2025Q1完成）。  
- 🚧 **SD卡存储**：FatFS集成与视频分段存储逻辑（进行中）。  
- 🚧 **人脸识别**：UART5协议联调与活体检测优化（硬件模块待测试）。  
- 🚧 **LVGL界面**：密码输入动画与状态提示界面（框架已实现，细节优化中）。  

---